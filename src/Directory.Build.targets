<?xml version="1.0" encoding="utf-8"?>
<Project>

  <Target Name="ClearGameFolderCopyLocal" AfterTargets="ResolveAssemblyReferences">
    <ItemGroup>
      <ReferenceCopyLocalPaths Remove="$(GameFolder)\*" />
    </ItemGroup>
  </Target>

  <Target Name="DefineConstants" BeforeTargets="CoreCompile">
    <PropertyGroup Condition=" '$(UsesPLib)' == 'true' ">
      <DefineConstants>$(DefineConstants);USESPLIB</DefineConstants>
    </PropertyGroup>
    <PropertyGroup Condition=" '$(UsesPLibOptions)' == 'true' ">
      <DefineConstants>$(DefineConstants);USESPLIBOPTIONS</DefineConstants>
    </PropertyGroup>
  </Target>

  <Target Name="AssemblyInfos" BeforeTargets="CoreCompile" Outputs="UpdatedAssemblyInfoFiles">
    <ItemGroup>
      <AssemblyInfoFiles Include="Properties\AssemblyInfos.cs"/>
    </ItemGroup>

    <Attrib Files="%(AssemblyInfoFiles.FullPath)" Normal="true" />
    <AssemblyInfo
        CodeLanguage="CS"
        OutputFile="%(AssemblyInfoFiles.FullPath)"
        AssemblyTitle="$(AssemblyName)"
        AssemblyDescription=""
        AssemblyConfiguration="$(Configuration)"
        AssemblyCompany="$(Company)"
        AssemblyProduct="$(Product)"
        AssemblyCopyright="$(Copyright)"
        AssemblyTrademark=""
        ComVisible="false" >
      <Output TaskParameter="OutputFile" ItemName="UpdatedAssemblyInfoFiles"/>
    </AssemblyInfo>

    <ItemGroup>
      <Compile Include="%(UpdatedAssemblyInfoFiles.FullPath)" />
    </ItemGroup>

  </Target>

  <Target Name="ILRepack" AfterTargets="Build" Condition=" '$(UsesPLib)' == 'true'  Or  '$(UsesPLibOptions)' == 'true' ">
    <ItemGroup>
      <InputAssemblies Include="$(TargetPath)" />
      <InputAssemblies Include="..\..\PLib\PLib.dll" Condition=" '$(UsesPLib)' == 'true'" />
      <InputAssemblies Include="..\..\PLib\PLibOptions.dll" Condition=" '$(UsesPLibOptions)' == 'true'" />
    </ItemGroup>

    <ILRepack
        TargetPlatformVersion="v4"
        TargetKind="SameAsPrimaryAssembly"
        OutputFile="$(TargetPath)"
        InputAssemblies="@(InputAssemblies)"
        LibraryPath="$(GameFolder)" />

  </Target>

  <Target Name="CopyArtifactsToInstallFolder" AfterTargets="ILRepack">
    <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Release|AnyCPU' ">
      <InstallFolder>$(ModOutputFolderRelease)\$(ProjectName)</InstallFolder>
    </PropertyGroup>
    <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Debug|AnyCPU' ">
      <InstallFolder>$(ModOutputFolderDebug)\$(ProjectName)</InstallFolder>
    </PropertyGroup>

    <ItemGroup>
      <AnimFiles Include="$(MSBuildProjectDirectory)\anim\**\*.*" />
      <SpritesFiles Include="$(MSBuildProjectDirectory)\sprites\*.*" />
      <ArchivedModVersions Include="$(MSBuildProjectDirectory)\archived_versions\**\*.*" />
      <TranslationFiles Include="$(MSBuildProjectDirectory)\translations\*.po" />
      <TranslationFiles Include="$(MSBuildProjectDirectory)\translations\*.pot" />
      <TranslationFiles Include="$(MSBuildProjectDirectory)\..\..\PLib\*.po" Condition=" '$(UsesPLibOptions)' == 'true'" />
      <WorldGenFiles Include="$(MSBuildProjectDirectory)\worldgen\**\*.*" />
      <YamlFiles Include="$(MSBuildProjectDirectory)\*.yaml" />
    </ItemGroup>

    <Copy SourceFiles="$(TargetPath)" DestinationFiles="$(InstallFolder)\$(TargetFileName)" />

    <Copy SourceFiles="@(AnimFiles)" DestinationFiles="@(AnimFiles->'$(InstallFolder)\anim\%(RecursiveDir)%(Filename)%(Extension)')" />
    <Copy SourceFiles="@(SpritesFiles)" DestinationFolder="$(InstallFolder)\sprites" />
    <Copy SourceFiles="@(ArchivedModVersions)" DestinationFiles="@(ArchivedModVersions->'$(InstallFolder)\archived_versions\%(RecursiveDir)%(Filename)%(Extension)')" />
    <Copy SourceFiles="@(TranslationFiles)" DestinationFolder="$(InstallFolder)\translations" />
    <Copy SourceFiles="@(WorldGenFiles)" DestinationFiles="@(WorldGenFiles->'$(InstallFolder)\worldgen\%(RecursiveDir)%(Filename)%(Extension)')" />
    <Copy SourceFiles="@(YamlFiles)" DestinationFolder="$(InstallFolder)" />
    <Copy SourceFiles="$(MSBuildProjectDirectory)\Preview.png" DestinationFiles="$(InstallFolder)\preview.png" Condition=" $(CopyPreview) == true " />

  </Target>

</Project>
